{% extends "base.html" %}

{% block content %}
<script>
    const addClassToTargetOnHover = (selector, className) => {
        const selected = document.querySelectorAll(selector);
        selected.forEach(source => {
            const target = document.querySelector('#' + source.attributes.target.value);
            source.addEventListener('mouseenter', () => {
                target.classList.add(className);
            });
            source.addEventListener('mouseleave', () => {
                target.classList.remove(className);
            });
        });
    };

    const makeOnlySelectedOptionVisible = () => {
        const actionRadios = document.querySelectorAll('.entity-actions input[type="radio"]');
        actionRadios.forEach(radio => {
            const controlledInputs = document.querySelectorAll('.' + radio.id);
            const entityId = radio.parentNode.parentNode.parentNode.parentNode.id;
            const allHiddenInputs = Array.from(document.querySelectorAll(`#${entityId} .action-hide`));

            radio.addEventListener('change', () => {
                allHiddenInputs.forEach(input => input.classList.add('action-hide'));
                if (controlledInputs) controlledInputs.forEach(input => input.classList.remove('action-hide'));
            });
        });
    };

    const displayRevitalizeCost = () => {
        const costMapping = {{ vitality_recovery_cost }};
        const revitalizeInputs = document.querySelectorAll('.revitalize-amount');
        revitalizeInputs.forEach(input => input.addEventListener('change', e => {
            const amount = e.target.valueAsNumber;
            input.previousElementSibling.textContent = costMapping[amount];
        }));
    };

    const changeMaxTransferValue = () => {
        const inputsByEntity = {};
        const transferInputs = document.querySelectorAll('[class*=__transfer-input]');
        transferInputs.forEach(input => {
            const entityId = input.className.split('__')[0];
            if (inputsByEntity[entityId]) {
                inputsByEntity[entityId].push(input);
            } else {
                inputsByEntity[entityId] = [input];
            }
        });
        Object.values(inputsByEntity).forEach(entityInputs => {
            entityInputs.forEach(input => {
                input.addEventListener('change', e => {
                    const amountChanged = e.target.value - e.target.dataset.value;
                    e.target.dataset.value = e.target.value;
                    entityInputs.filter(i => i !== input).forEach(otherInput => {
                        otherInput.max -= amountChanged;
                    });
                });
            });
        });
    };

    window.onload = () => {
        addClassToTargetOnHover('.attack', 'attack-target');
        addClassToTargetOnHover('.transfer', 'transfer-target');
        makeOnlySelectedOptionVisible();
        displayRevitalizeCost();
        changeMaxTransferValue();
    };
</script>
<div>
    {% with messages = get_flashed_messages(category_filter=['validation'], with_categories=true) %}
    {% if messages %}
    <ul class="flashes">
        {% for category, message in messages %}
        <li class="{{ category }}">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}
</div>
<form id="board" method="post" action="board">
    <div class="month">{{ turn_to_month(context.board_state.turn) }}</div>
    <input type="hidden" id="turn" name="turn" value="{{ context.board_state.turn }}">
    {% for team in context.board_state.teams %}
    <div id="{{ team }}">
        <div class="core">
            <div class="triangle">
                {% for entity in context.board_state.teams[team].entities.values() %}
                <div class="card" id={{ entity.id }}>
                    {% include 'entity.html' %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endfor %}
    <fieldset id="message-log">
        <legend>Message Log</legend>
        <ul>
            {% for msg in context.message_log | reverse %}
            <li>{{ msg }}</li>
            {% endfor %}
        </ul>
    </fieldset>
    <input type="submit" value="Finish turn" class="finish-turn-btn">
</form>
{% endblock %}
